# TIP-1016 State Gas — Test Plan

TIP-1016 adds dual-limit gas accounting: **execution gas** (CPU work) is tracked
separately from **state gas** (storage creation, account creation, code deposit).

All tests use these state gas costs:

| GasId | Cost |
|---|---|
| `sstore_set_state_gas` | 20,000 |
| `new_account_state_gas` | 25,000 |
| `code_deposit_state_gas` | 200 / byte |
| `create_state_gas` | 32,000 |

---

## Category 1: SSTORE State Gas

| # | Test Name | Description | Without State Gas | With State Gas |
|---|-----------|-------------|-------------------|----------------|
| 1.1 | `test_tip1016_sstore_new_slot` | SSTORE zero→non-zero on fresh slot. Charges `sstore_set_state_gas`. | ~43,106 (exec only) | ~63,106 (+20,000 state gas) |
| 1.2 | `test_tip1016_sstore_overwrite_no_state_gas` | Two SSTOREs to same slot: 0→1 then 1→2. Second SSTORE has `is_original_eq_present()=false`, so no additional state gas. | ~65,212 | ~85,212 (+20,000 for first only) |
| 1.3 | `test_tip1016_sstore_zero_to_zero_no_state_gas` | SSTORE writing zero to already-zero slot. No new slot creation. | ~43,106 | ~43,106 (+0) |
| 1.4 | `test_tip1016_sstore_multiple_new_slots` | 3 SSTOREs each creating new slots (keys 0,1,2). | ~109,318 | ~169,318 (+60,000 = 3×20,000) |

## Category 2: CREATE State Gas

| # | Test Name | Description | Without State Gas | With State Gas |
|---|-----------|-------------|-------------------|----------------|
| 2.1 | `test_tip1016_create_empty_code` | CREATE deploying 0-byte contract. Charges `new_account_state_gas` + `create_state_gas`. | exec only | +57,000 (25k+32k) |
| 2.2 | `test_tip1016_create_with_code` | CREATE deploying 10-byte contract. Charges all three CREATE state gas components. | exec only | +59,000 (25k+32k+2k) |
| 2.3 | `test_tip1016_create_with_sstore` | CREATE whose init code does SSTORE (new slot) and returns 1-byte code. All 4 state gas types charged. | exec only | +77,200 (25k+32k+20k+200) |

## Category 3: CALL State Gas

| # | Test Name | Description | Without State Gas | With State Gas |
|---|-----------|-------------|-------------------|----------------|
| 3.1 | `test_tip1016_call_new_account` | CALL with value to non-existent account. Charges `new_account_state_gas`. | exec only | +25,000 |
| 3.2 | `test_tip1016_call_existing_account` | CALL with value to existing account (BENCH_CALLER). No state gas. | exec only | +0 (same) |

## Category 4: CPU Gas Cap Enforcement

| # | Test Name | Description | Without State Gas | With State Gas |
|---|-----------|-------------|-------------------|----------------|
| 4.1 | `test_tip1016_cpu_cap_causes_oog` | SSTORE with tight `tx_gas_limit_cap=30,000`. CPU budget insufficient for execution. | Success | Halt(OOG) |
| 4.2 | `test_tip1016_cpu_cap_sufficient` | SSTORE with adequate `tx_gas_limit_cap=100,000`. CPU budget sufficient. | Success | Success |
| 4.3 | `test_tip1016_state_gas_oog_remaining` | SSTORE with `gas_limit=50,000`. Enough CPU but `remaining` insufficient after state gas deduction. | Success | Halt(OOG) |

## Category 5: State Gas Propagation

| # | Test Name | Description | Without State Gas | With State Gas |
|---|-----------|-------------|-------------------|----------------|
| 5.1 | `test_tip1016_create_child_propagates` | CREATE with init code that does SSTORE. Child's state gas propagates to parent on success. | exec only | +77,200 (all 4 types) |
| 5.2 | `test_tip1016_reverted_create_child` | CREATE with init code that does SSTORE then REVERT. Parent's state gas persists; child's state gas is not propagated but the gas is consumed (not returned). | exec only | +77,000 (25k+32k parent + 20k child lost) |

## Category 6: Interactions

| # | Test Name | Description | Without State Gas | With State Gas |
|---|-----------|-------------|-------------------|----------------|
| 6.1 | `test_tip1016_sstore_set_then_clear_refund` | SSTORE 0→1 (state gas), then SSTORE 1→0 (refund). Refund does NOT undo state gas, but state gas raises the refund cap (spent/5). Net delta = state_gas × 4/5. | gas minus refund | gas minus refund (+16,000 net) |
| 6.2 | `test_tip1016_state_gas_does_not_reduce_cpu` | SSTORE with `tx_gas_limit_cap=50,000` (cpu=29,000). Exec fits in cpu, state gas doesn't consume cpu. | Success | Success |
